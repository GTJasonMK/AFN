{
  "tasks": {
    "contributors_guide": {
      "task": "编写仓库贡献者指南（AGENTS.md）",
      "location": {
        "root": [
          "run_app.py 统一启动脚本",
          "build.bat 打包脚本",
          "docs/ 架构与文档",
          "backend/ FastAPI 异步后端",
          "frontend/ PyQt6 桌面前端",
          "storage/ 日志与数据库"
        ],
        "source_focus": {
          "backend": "app/ 目录下的 api/routers、services、repositories、models、schemas",
          "frontend": "main.py、windows/ 页面、components/ 组件、api/client/ Mixin 客户端"
        }
      },
      "current_state": {
        "documentation": [
          "README.md 提供总体介绍、结构和启动方式",
          "CLAUDE.md 记录详细开发规范和命令",
          "frontend/README.md、backend/README.md 提供子模块说明",
          "尚未发现面向贡献者的 AGENTS.md 文件"
        ],
        "process": "run_app.py 负责一键创建虚拟环境、安装依赖并启动前后端；backend 和 frontend 均有独立 README 与 start 脚本"
      },
      "similar_examples": [
        "README.md 的 项目结构 与 命令示例 可作为贡献指南的参考内容",
        "CLAUDE.md 描述的开发规范可提炼到贡献者指南"
      ],
      "tech_stack": [
        "Python 3.10+",
        "FastAPI 0.110.0 + SQLAlchemy 2.0 + aiosqlite",
        "PyQt6 6.6.1 前端",
        "ChromaDB / OpenAI 兼容 LLM",
        "uv 包管理器加速依赖安装"
      ],
      "tests_and_validation": {
        "current": "仓库未发现标准化测试目录，仅零散测试脚本；现阶段以手动验证和日志检查为主",
        "tooling": "CLAUDE.md 要求改动需通过手动自测，run_app.py 提供启动与日志定位"
      },
      "observation_report": [
        {
          "type": "info",
          "detail": "前后端分离但通过 run_app.py 打包统一启动，指南需强调该脚本"
        },
        {
          "type": "risk",
          "detail": "缺乏自动化测试框架，需要在贡献指南中明确手动测试与日志检查要求"
        },
        {
          "type": "info",
          "detail": "文档与注释统一使用中文，贡献指南应保持中文说明但标题按需求使用英文"
        }
      ]
    },
    "manga_prompt_review": {
      "task": "审查文本转漫画提示词构建与 PDF 导出逻辑",
      "location": {
        "backend": [
          "app/services/manga_prompt/ extraction / planning / storyboard / prompt_builder",
          "app/services/image_generation/pdf_export.py",
          "app/repositories/chapter_repository.py/GeneratedImage 表"
        ],
        "frontend": [
          "frontend/windows/writing_desk/panels/manga/*",
          "frontend/windows/writing_desk/optimization/manga handlers"
        ],
        "docs": [
          "docs/MANGA_PROMPT_REFACTOR_PLAN.md",
          "docs/MANGA_OPTIMIZATION_PLAN.md"
        ]
      },
      "current_state": {
        "pipeline": "backend MangaPromptServiceV2 走 4 步：ChapterInfoExtractor → PagePlanner → StoryboardDesigner → PromptBuilder (无LLM)；结果写入 ChapterMangaPrompt + 断点 checkpoint",
        "pdf_generation": "PDFExportService 提供 generate_chapter_manga_pdf（逐图一页）与 generate_professional_manga_pdf（按 layout_slot 排版），依赖 GeneratedImage.panel_id 及 manga_prompt.panels 数据"
      },
      "similar_examples": [
        "docs/MANGA_PROMPT_REFACTOR_PLAN.md 描述过往问题与目标，可比对实际实现",
        "frontend/writing_desk/panels/manga/builder.py 对接 backend prompt result，生成 UI + 导出"
      ],
      "tech_stack": [
        "LLM 提示词 orchestrated by PromptService / LLMService",
        "ReportLab + Pillow for PDF",
        "SQLite + SQLAlchemy models ChapterMangaPrompt / GeneratedImage"
      ],
      "tests_and_validation": {
        "current": "无自动化测试覆盖 manga prompt；Debug 依赖 storage/debug.log 与 manual SSE 输出",
        "tooling": "PDF 生成 rely on reportlab; prompt builder purely Python"
      },
      "observation_report": [
        {
          "type": "risk",
          "detail": "PromptBuilder 强制移除对话/音效 textual hints，可能导致AI忽视剧情；dialogue 仅保存在 metadata 但 PDF pipeline 未使用"
        },
        {
          "type": "risk",
          "detail": "generate_professional_manga_pdf 依赖 panel_id 与 GeneratedImage 映射，实际生成流程未确保 panel_id 与图片对应，造成空白或乱序"
        },
        {
          "type": "info",
          "detail": "PDFService 缺少对 aspect_ratio / layout_slot 与页面网格的映射，可能使 prompt 结果无法正确展现"
        }
      ]
    },
    "novel_workflow_bug_hunt": {
      "task": "持续排查小说章节生成工作流的逻辑缺陷",
      "location": {
        "workflow": "backend/app/services/chapter_generation/workflow.py（状态校验、版本写入、错误回滚）",
        "service": "backend/app/services/chapter_generation/service.py、chapter_version_service.py（上下文收集、版本处理、索引）",
        "api": "backend/app/api/routers/writer/chapter_generation.py（生成/重试/预览路由）",
        "docs": "docs/BUG_REPORT.md 用于记录发现的问题"
      },
      "current_state": {
        "pipeline": "ChapterGenerationWorkflow 按五阶段运行（初始化→上下文→提示词→版本生成→保存），最终通过 NovelService 替换版本并 commit",
        "retry_flow": "chapter_generation router 的 retry_chapter_version 直接覆盖版本内容，不触发索引/摘要刷新（已在 BUG_REPORT 记录）",
        "usage": "docs/BUG_REPORT.md 已列出 6 个缺陷，重点围绕空白项目、用量统计、重试流程等"
      },
      "similar_examples": [
        "chapter_management.py 中 select_chapter_version 流程展示了完整的摘要/索引/向量更新链路，可对比生成流程的缺口",
        "ForeshadowingService、EnhancedChapterContextService 展示了 RAG/伏笔数据如何参与 prompt，便于判断遗漏"
      ],
      "tech_stack": [
        "FastAPI + AsyncSession 协调路由和服务",
        "LLMService 管理章节写作、摘要与嵌入",
        "SQLAlchemy ORM（Chapter/ChapterVersion/Indexes）",
        "可选 VectorStoreService（Chroma/SQLite）驱动 RAG"
      ],
      "tests_and_validation": {
        "current": "章节生成没有自动化测试，依赖手工审阅 storage/logs 以及 GUI 冒烟，BUG_REPORT 需提供代码证据",
        "tooling": "调试重点是 backend/app/services/chapter_generation/* 与相关 router，不涉及前端"
      },
      "observation_report": [
        {
          "type": "info",
          "detail": "章节生成涉及多个状态迁移（ProjectStatus/ChapterGenerationStatus），需要检查失败/取消时是否正确回滚"
        },
        {
          "type": "risk",
          "detail": "重试、并行生成、空白项目等边界路径众多，docs/BUG_REPORT.md 必须持续更新，避免遗漏"
        },
        {
          "type": "risk",
          "detail": "Vector Store 默认未启用，需确认提示词在无 RAG 情况下是否仍能注入伏笔/角色约束"
        }
      ]
    }
  }
}
