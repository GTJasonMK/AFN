# AFN (Agents for Novel) 项目功能分析报告

## 1. 项目概述
AFN (Agents for Novel) 是一个基于大语言模型（LLM）驱动的智能化小说创作与辅助系统。该系统采用前后端分离架构，后端基于 FastAPI 提供异步 API 服务，前端基于 PyQt6 构建高性能桌面客户端。系统核心目标是通过多智能体协作，实现从灵感碰撞、蓝图构建、大纲生成到正文创作及漫画分镜转化的全流程自动化与半自动化辅助。

## 2. 核心功能模块

### 2.1 灵感与概念阶段 (Inspiration & Concept)
- **灵感对话 (Inspiration Dialogue)**：通过与 AI 的连续对话，捕捉并细化用户的创作灵感。
- **蓝图自动生成 (Blueprint Generation)**：基于对话内容，自动提取并生成小说蓝图，包括标题、受众、类型、风格、基调、一句话梗概及详细大纲。
- **世界观设定 (World Setting)**：支持复杂的 JSON 格式世界观配置，涵盖地理、力量体系、社会结构等。
- **个性化头像生成 (Avatar Generation)**：利用 LLM 生成描述并转化为 SVG 格式的小动物图标，作为项目的视觉标识。

### 2.2 创作管理与状态机 (Project Management & State Machine)
- **严谨的状态流转**：系统内置 `ProjectStateMachine`，管理项目从 `DRAFT` (草稿) -> `BLUEPRINT_READY` (蓝图就绪) -> `PART_OUTLINES_READY` (分部大纲) -> `CHAPTER_OUTLINES_READY` (章节大纲) -> `WRITING` (写作中) -> `COMPLETED` (已完成) 的全生命周期。
- **状态验证与回退保护**：通过 `state_validators` 确保操作的合法性，并提供回退时的自动清理机制。
- **连贯性保护机制**：在写作阶段，防止在已有正文的章节之前插入新内容，确保故事逻辑的线性一致性。

### 2.3 智能化写作引擎 (Intelligent Writing Engine)
- **RAG 增强生成 (Retrieval-Augmented Generation)**：利用向量数据库（ChromaDB/libsql）检索历史章节、角色状态和伏笔，确保长篇创作的上下文连贯。
- **多级大纲体系**：支持“分部大纲 (Part Outlines)”与“章节大纲 (Chapter Outlines)”两级结构，适配长篇小说创作。
- **章节多版本管理**：同一章节支持生成多个版本，用户可进行评估、对比并选择最佳版本。
- **智能评估系统**：对生成的章节进行多维度评分（逻辑、文笔、节奏等）并提供改进建议。

### 2.4 角色与剧情追踪 (Character & Plot Tracking)
- **主角档案系统 (Protagonist Profile)**：
    - **三维属性追踪**：显性（外貌/装备）、隐性（性格/习惯）、社会（关系/地位）属性的动态管理。
    - **证据溯源 (Evidence Sourcing)**：每一项属性变更都必须关联原文引用，确保 AI 不会凭空捏造。
    - **行为一致性分析**：记录主角行为并与性格标签匹配，检测人设崩塌风险。
    - **删除保护机制**：属性删除需经过多次标记确认，防止误删关键设定。
- **伏笔索引 (Foreshadowing Index)**：自动提取文中埋下的伏笔，追踪其回收状态（Pending/Resolved），并智能提醒作者在后续章节中回收。
- **角色状态快照**：记录每章结束时角色的位置、情感状态及关系变化。

### 2.5 内容优化与 Agent 协作 (Content Optimization)
- **智能优化 Agent**：采用 Agent 架构，自主调用工具（如段落分析、连贯性检查）对正文进行精修。
- **多维度分析**：涵盖词汇丰富度、情感曲线、逻辑漏洞检测等。

### 2.6 漫画分镜转化 (Manga Storyboarding V2)
- **文本转分镜逻辑**：将小说正文自动转化为专业的漫画分镜提示词。
- **V2 架构核心**：
    - **场景提取与展开**：自动识别叙事场景并进行视觉化扩充。
    - **专业页面模板**：内置 8 种专业漫画布局模板，适配不同情感氛围。
    - **角色外观一致性 (Character Consistency)**：生成并维护全局角色外观 Profile，确保 AI 绘图时角色形象统一。
    - **断点续传 (Checkpointing)**：支持长章节转化的进度保存与恢复。

### 2.7 图像生成集成 (Image Generation)
- **多供应商支持**：集成 ComfyUI、Stability AI 及 OpenAI 兼容接口。
- **角色立绘生成**：基于角色档案自动生成视觉形象。

## 3. 技术架构亮点

### 3.1 后端技术栈
- **框架**：FastAPI (异步、高性能)。
- **数据库**：SQLAlchemy ORM，支持 MySQL (生产) 与 SQLite (本地) 切换。
- **向量检索**：集成 RAG 流程，支持增量索引与上下文构建。
- **并发处理**：基于 SSE (Server-Sent Events) 的流式响应，提供实时的 AI 生成反馈。

### 3.2 前端技术栈
- **框架**：PyQt6 (桌面原生体验)。
- **主题系统**：支持 V1 (常量驱动) 与 V2 (组件驱动) 两套主题架构，具备深色/浅色模式及可访问性增强。
- **动态 UI**：基于粒子效果 (Particles) 和卡片式布局的现代化主页设计。
- **异步通信**：内置 SSE Worker 处理长连接，确保 UI 界面不卡顿。

### 3.3 导入分析系统
- **外部项目导入**：支持导入外部小说文本，通过 `import_analysis` 服务自动提取蓝图、大纲及角色设定，实现旧作的智能化接续创作。

## 4. 总结
AFN 项目不仅是一个简单的 AI 写作工具，它构建了一套完整的**小说创作工业化流水线**。通过严谨的状态机管理、深度的人设/伏笔追踪以及专业的漫画转化能力，极大地降低了长篇叙事创作的门槛，并保证了内容的高质量与逻辑一致性。