"""
写作台精美Modal对话框组件（禅意风格）

完全照抄Vue3的UI设计规范，替代系统原生对话框
对应Vue3组件：
- WDEditChapterModal.vue
- WDEvaluationDetailModal.vue
- WDVersionDetailModal.vue
- WDGenerateOutlineModal.vue
"""

from PyQt6.QtWidgets import (
    QDialog, QFrame, QHBoxLayout, QLabel, QLineEdit, QPushButton,
    QScrollArea, QSpinBox, QTextEdit, QVBoxLayout, QWidget, QApplication, QGraphicsDropShadowEffect
)
from PyQt6.QtCore import pyqtSignal, Qt
from PyQt6.QtGui import QColor
from themes.theme_manager import theme_manager
from utils.dpi_utils import dpi_helper, dp, sp, responsive
import json


class WDEditChapterModal(QDialog):
    """编辑章节大纲对话框 - 禅意风格

    对应Vue3组件：WDEditChapterModal.vue

    UI规范：
    - 遮罩层：30%黑色半透明
    - 最大宽度：512px
    - 圆角：16px
    - 输入框：标题input + 摘要textarea(5行)
    - 按钮：取消(灰色) + 保存(灰绿色)
    """

    saved = pyqtSignal(dict)  # 保存时发射：{title, summary}

    def __init__(self, chapter_data=None, parent=None):
        super().__init__(parent)
        self.chapter_data = chapter_data or {}
        self.title_input = None
        self.summary_input = None
        self.dialog_widget = None
        self.cancel_btn = None
        self.save_btn = None
        self.close_btn = None

        self.setWindowFlags(Qt.WindowType.FramelessWindowHint | Qt.WindowType.Dialog)
        self.setAttribute(Qt.WidgetAttribute.WA_TranslucentBackground)
        self.setupUI()

        # 连接主题变化信号
        theme_manager.theme_changed.connect(self._apply_theme)

    def setupUI(self):
        """初始化UI"""
        # 主布局（包含遮罩效果）
        main_layout = QVBoxLayout(self)
        main_layout.setContentsMargins(0, 0, 0, 0)

        # 遮罩层（半透明）
        overlay = QWidget(self)
        overlay_color = theme_manager.OVERLAY_COLOR
        overlay.setStyleSheet(f"background-color: {overlay_color};")
        overlay.mousePressEvent = lambda e: self.reject() if e.button() == Qt.MouseButton.LeftButton else None

        # 对话框容器（居中）
        container_layout = QVBoxLayout(overlay)
        container_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)

        # 对话框主体
        self.dialog_widget = QWidget()
        self.dialog_widget.setFixedWidth(dp(512))  # max-w-lg = 32rem = 512px

        dialog_layout = QVBoxLayout(self.dialog_widget)
        dialog_layout.setContentsMargins(dp(20), dp(20), dp(20), dp(20))  # 减小from 32px
        dialog_layout.setSpacing(dp(16))  # 减小from 24px

        # 顶部标题和关闭按钮
        header_layout = QHBoxLayout()

        title_label = QLabel("编辑章节大纲")
        title_label.setStyleSheet(f"""
            font-size: {sp(24)}px;
            font-weight: 700;
            color: {theme_manager.TEXT_PRIMARY};
        """)
        header_layout.addWidget(title_label)

        header_layout.addStretch()

        self.close_btn = QPushButton("✕")
        self.close_btn.setFixedSize(dp(36), dp(36))
        self.close_btn.setCursor(Qt.CursorShape.PointingHandCursor)
        self.close_btn.clicked.connect(self.reject)
        header_layout.addWidget(self.close_btn)

        dialog_layout.addLayout(header_layout)

        # 表单区域
        form_layout = QVBoxLayout()
        form_layout.setSpacing(16)  # 减小from 24px

        # 章节标题输入框
        title_label = QLabel("章节标题")
        title_label.setStyleSheet(f"""
            font-size: {sp(14)}px;
            font-weight: 500;
            color: {theme_manager.TEXT_SECONDARY};
            margin-bottom: 8px;
        """)
        form_layout.addWidget(title_label)

        self.title_input = QLineEdit()
        self.title_input.setPlaceholderText("请输入章节标题")
        self.title_input.setText(self.chapter_data.get('title', ''))
        form_layout.addWidget(self.title_input)

        # 章节摘要输入框
        summary_label = QLabel("章节摘要")
        summary_label.setStyleSheet(f"""
            font-size: {sp(14)}px;
            font-weight: 500;
            color: {theme_manager.TEXT_SECONDARY};
            margin-bottom: 8px;
        """)
        form_layout.addWidget(summary_label)

        self.summary_input = QTextEdit()
        self.summary_input.setPlaceholderText("请输入章节摘要")
        self.summary_input.setPlainText(self.chapter_data.get('summary', ''))
        self.summary_input.setMinimumHeight(120)  # 约5行
        form_layout.addWidget(self.summary_input)

        dialog_layout.addLayout(form_layout)

        # 底部按钮
        buttons_layout = QHBoxLayout()
        buttons_layout.addStretch()

        self.cancel_btn = QPushButton("取消")
        self.cancel_btn.setFixedHeight(dp(32))  # 减小from 40px
        self.cancel_btn.setCursor(Qt.CursorShape.PointingHandCursor)
        self.cancel_btn.clicked.connect(self.reject)
        buttons_layout.addWidget(self.cancel_btn)

        self.save_btn = QPushButton("保存更改")
        self.save_btn.setFixedHeight(dp(32))  # 减小from 40px
        self.save_btn.setCursor(Qt.CursorShape.PointingHandCursor)
        self.save_btn.clicked.connect(self.onSave)
        buttons_layout.addWidget(self.save_btn)

        dialog_layout.addLayout(buttons_layout)

        container_layout.addWidget(self.dialog_widget)
        main_layout.addWidget(overlay)

        # 应用主题
        self._apply_theme()

    def _apply_theme(self):
        """应用主题样式"""
        if self.dialog_widget:
            self.dialog_widget.setStyleSheet(f"""
                QWidget {{
                    background-color: {theme_manager.BG_CARD};
                    border-radius: {theme_manager.RADIUS_LG};
                }}
            """)

        if self.close_btn:
            self.close_btn.setStyleSheet(f"""
                QPushButton {{
                    background-color: transparent;
                    color: {theme_manager.TEXT_SECONDARY};
                    border: none;
                    border-radius: {theme_manager.RADIUS_SM};
                    font-size: {sp(20)}px;
                }}
                QPushButton:hover {{
                    background-color: {theme_manager.SUCCESS_BG};
                    color: {theme_manager.TEXT_PRIMARY};
                }}
            """)

        if self.title_input:
            self.title_input.setStyleSheet(f"""
                QLineEdit {{
                    padding: 8px 16px;
                    border: 1px solid {theme_manager.BORDER_DEFAULT};
                    border-radius: {theme_manager.RADIUS_SM};
                    font-size: {sp(15)}px;
                    background-color: {theme_manager.BG_TERTIARY};
                    color: {theme_manager.TEXT_PRIMARY};
                }}
                QLineEdit:focus {{
                    border: 2px solid {theme_manager.PRIMARY};
                    outline: none;
                }}
            """)

        if self.summary_input:
            self.summary_input.setStyleSheet(f"""
                QTextEdit {{
                    padding: 8px 16px;
                    border: 1px solid {theme_manager.BORDER_DEFAULT};
                    border-radius: {theme_manager.RADIUS_SM};
                    font-size: {sp(15)}px;
                    background-color: {theme_manager.BG_TERTIARY};
                    color: {theme_manager.TEXT_PRIMARY};
                }}
                QTextEdit:focus {{
                    border: 2px solid {theme_manager.PRIMARY};
                    outline: none;
                }}
            """)

        if self.cancel_btn:
            self.cancel_btn.setStyleSheet(theme_manager.button_secondary())

        if self.save_btn:
            self.save_btn.setStyleSheet(f"""
                QPushButton {{
                    background-color: {theme_manager.PRIMARY};
                    color: {theme_manager.BUTTON_TEXT};
                    border: none;
                    border-radius: {theme_manager.RADIUS_SM};
                    padding: 0 24px;
                    font-size: {theme_manager.FONT_SIZE_SM};
                    font-weight: {theme_manager.FONT_WEIGHT_SEMIBOLD};
                }}
                QPushButton:hover {{
                    background-color: {theme_manager.WARNING};
                }}
                QPushButton:disabled {{
                    background-color: {theme_manager.TEXT_DISABLED};
                    opacity: 0.5;
                }}
            """)

    def onSave(self):
        """保存更改"""
        title = self.title_input.text().strip()
        summary = self.summary_input.toPlainText().strip()

        # 检查是否有更改
        if (title != self.chapter_data.get('title', '') or
            summary != self.chapter_data.get('summary', '')):
            self.saved.emit({'title': title, 'summary': summary})
            self.accept()
        else:
            self.reject()


class WDEvaluationDetailModal(QDialog):
    """评审详情对话框 - 禅意风格

    对应Vue3组件：WDEvaluationDetailModal.vue

    UI规范：
    - 遮罩层：50%黑色半透明 + 背景模糊
    - 最大宽度：896px (max-w-4xl)
    - 最大高度：80vh
    - 特色图标：灰绿色圆形 + 铃铛图标
    - 内容：JSON解析显示评审结果或Markdown渲染
    """

    def __init__(self, evaluation_text='', parent=None):
        super().__init__(parent)
        self.evaluation_text = evaluation_text

        # 存储UI组件引用
        self.overlay = None
        self.dialog_widget = None
        self.header = None
        self.icon_label = None
        self.title_label = None
        self.close_btn = None
        self.scroll_area = None
        self.content_widget = None
        self.eval_label = None
        self.footer = None
        self.close_footer_btn = None
        self.structured_cards = []  # 存储结构化评审卡片

        self.setWindowFlags(Qt.WindowType.FramelessWindowHint | Qt.WindowType.Dialog)
        self.setAttribute(Qt.WidgetAttribute.WA_TranslucentBackground)

        # 获取屏幕尺寸计算80vh
        screen = QApplication.primaryScreen().geometry()
        self.max_height = int(screen.height() * 0.8)

        self.setupUI()

        # 连接主题变化信号
        theme_manager.theme_changed.connect(self._apply_theme)

    def setupUI(self):
        """初始化UI"""
        # 主布局
        main_layout = QVBoxLayout(self)
        main_layout.setContentsMargins(0, 0, 0, 0)

        # 遮罩层（50%黑色半透明）
        self.overlay = QWidget(self)
        self.overlay.mousePressEvent = lambda e: self.reject() if e.button() == Qt.MouseButton.LeftButton else None

        # 对话框容器
        container_layout = QVBoxLayout(self.overlay)
        container_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)
        container_layout.setContentsMargins(16, 16, 16, 16)

        # 对话框主体
        self.dialog_widget = QWidget()
        self.dialog_widget.setFixedWidth(dp(896))  # max-w-4xl = 56rem = 896px
        self.dialog_widget.setMaximumHeight(self.max_height)

        # 阴影效果
        shadow = QGraphicsDropShadowEffect()
        shadow.setBlurRadius(40)
        shadow.setColor(QColor(0, 0, 0, 60))
        shadow.setOffset(0, 10)
        self.dialog_widget.setGraphicsEffect(shadow)

        dialog_layout = QVBoxLayout(self.dialog_widget)
        dialog_layout.setContentsMargins(0, 0, 0, 0)
        dialog_layout.setSpacing(0)

        # 头部
        self.header = QWidget()
        header_layout = QHBoxLayout(self.header)
        header_layout.setContentsMargins(20, 16, 20, 16)  # 减小padding

        # 左侧：图标 + 标题
        left_layout = QHBoxLayout()
        left_layout.setSpacing(12)

        # 灰绿色圆形图标
        self.icon_label = QLabel()
        self.icon_label.setFixedSize(dp(40), dp(40))
        self.icon_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.icon_label.setText("◑")
        left_layout.addWidget(self.icon_label)

        self.title_label = QLabel("AI 评审详情")
        left_layout.addWidget(self.title_label)

        header_layout.addLayout(left_layout)
        header_layout.addStretch()

        # 关闭按钮
        self.close_btn = QPushButton("✕")
        self.close_btn.setFixedSize(dp(36), dp(36))
        self.close_btn.setCursor(Qt.CursorShape.PointingHandCursor)
        self.close_btn.clicked.connect(self.reject)
        header_layout.addWidget(self.close_btn)

        dialog_layout.addWidget(self.header)

        # 内容区域
        self.scroll_area = QScrollArea()
        self.scroll_area.setWidgetResizable(True)
        self.scroll_area.setFrameShape(QFrame.Shape.NoFrame)

        self.content_widget = QWidget()
        content_layout = QVBoxLayout(self.content_widget)
        content_layout.setContentsMargins(20, 16, 20, 16)  # 减小from 24px
        content_layout.setSpacing(16)  # 减小from 24px

        # 解析评审内容
        parsed_eval = self.parseEvaluation()

        if parsed_eval:
            # JSON格式的评审结果
            self.renderStructuredEvaluation(content_layout, parsed_eval)
        else:
            # Markdown格式
            self.eval_label = QLabel(self.evaluation_text or '暂无评审内容')
            self.eval_label.setWordWrap(True)
            self.eval_label.setTextFormat(Qt.TextFormat.RichText)
            content_layout.addWidget(self.eval_label)

        content_layout.addStretch()
        self.scroll_area.setWidget(self.content_widget)
        dialog_layout.addWidget(self.scroll_area)

        # 底部按钮
        self.footer = QWidget()
        footer_layout = QHBoxLayout(self.footer)
        footer_layout.setContentsMargins(24, 16, 24, 16)
        footer_layout.addStretch()

        self.close_footer_btn = QPushButton("关闭")
        self.close_footer_btn.setMinimumHeight(32)  # 减小from 40px
        self.close_footer_btn.setMinimumWidth(64)   # 减小from 88px
        self.close_footer_btn.setCursor(Qt.CursorShape.PointingHandCursor)
        self.close_footer_btn.clicked.connect(self.reject)
        footer_layout.addWidget(self.close_footer_btn)

        dialog_layout.addWidget(self.footer)

        container_layout.addWidget(self.dialog_widget)
        main_layout.addWidget(self.overlay)

        # 应用主题
        self._apply_theme()

    def _apply_theme(self):
        """应用主题样式"""
        # 获取当前是否为深色模式
        is_dark = theme_manager.is_dark_mode()

        if self.overlay:
            # 使用主题遮罩层颜色
            overlay_color = theme_manager.OVERLAY_COLOR
            self.overlay.setStyleSheet(f"background-color: {overlay_color};")

        if self.dialog_widget:
            self.dialog_widget.setStyleSheet(f"""
                QWidget {{
                    background-color: {theme_manager.BG_CARD};
                    border-radius: {theme_manager.RADIUS_LG};
                }}
            """)

        if self.header:
            self.header.setStyleSheet(f"""
                QWidget {{
                    background-color: {theme_manager.BG_TERTIARY};
                    border-bottom: 1px solid {theme_manager.BORDER_LIGHT};
                    border-top-left-radius: {theme_manager.RADIUS_LG};
                    border-top-right-radius: {theme_manager.RADIUS_LG};
                }}
            """)

        if self.icon_label:
            self.icon_label.setStyleSheet(f"""
                background-color: {theme_manager.PRIMARY};
                color: {theme_manager.BUTTON_TEXT};
                border-radius: 20px;
                font-size: 24px;
            """)

        if self.title_label:
            self.title_label.setStyleSheet(f"""
                font-size: {sp(20)}px;
                font-weight: 700;
                color: {theme_manager.TEXT_PRIMARY};
            """)

        if self.close_btn:
            self.close_btn.setStyleSheet(f"""
                QPushButton {{
                    background-color: transparent;
                    color: {theme_manager.TEXT_SECONDARY};
                    border: none;
                    border-radius: {theme_manager.RADIUS_SM};
                    font-size: {sp(20)}px;
                }}
                QPushButton:hover {{
                    background-color: {theme_manager.SUCCESS_BG};
                    color: {theme_manager.TEXT_PRIMARY};
                }}
            """)

        if self.scroll_area:
            self.scroll_area.setStyleSheet(f"""
                QScrollArea {{
                    background-color: {theme_manager.BG_TERTIARY};
                    border: none;
                }}
                {theme_manager.scrollbar()}
            """)

        if self.eval_label:
            self.eval_label.setStyleSheet(f"""
                font-size: {sp(14)}px;
                color: {theme_manager.TEXT_PRIMARY};
                line-height: 1.6;
            """)

        if self.footer:
            self.footer.setStyleSheet(f"""
                QWidget {{
                    background-color: {theme_manager.BG_SECONDARY};
                    border-top: 1px solid {theme_manager.BORDER_LIGHT};
                    border-bottom-left-radius: {theme_manager.RADIUS_LG};
                    border-bottom-right-radius: {theme_manager.RADIUS_LG};
                }}
            """)

        if self.close_footer_btn:
            self.close_footer_btn.setStyleSheet(f"""
                QPushButton {{
                    background-color: {theme_manager.PRIMARY};
                    color: {theme_manager.BUTTON_TEXT};
                    border: none;
                    border-radius: {theme_manager.RADIUS_SM};
                    padding: 0 24px;
                    font-size: {theme_manager.FONT_SIZE_SM};
                    font-weight: {theme_manager.FONT_WEIGHT_SEMIBOLD};
                }}
                QPushButton:hover {{
                    background-color: {theme_manager.WARNING};
                }}
            """)

        # 更新结构化评审卡片样式
        for card_widget in self.structured_cards:
            if hasattr(card_widget, '_is_best_card') and card_widget._is_best_card:
                # 最佳选择卡片
                card_widget.setStyleSheet(f"""
                    QFrame {{
                        background-color: {theme_manager.SUCCESS_BG};
                        border: 1px solid {theme_manager.INFO};
                        border-radius: {theme_manager.RADIUS_MD};
                        padding: 16px;
                    }}
                """)
            else:
                # 普通版本卡片
                card_widget.setStyleSheet(f"""
                    QFrame {{
                        background-color: {theme_manager.BG_SECONDARY};
                        border: 1px solid {theme_manager.BORDER_DEFAULT};
                        border-radius: {theme_manager.RADIUS_SM};
                        padding: 16px;
                    }}
                """)

    def parseEvaluation(self):
        """解析评审JSON"""
        if not self.evaluation_text:
            return None
        try:
            data = json.loads(self.evaluation_text)
            if isinstance(data, str):
                data = json.loads(data)
            return data
        except (json.JSONDecodeError, ValueError, TypeError):
            return None

    def renderStructuredEvaluation(self, layout, parsed_eval):
        """渲染结构化评审结果"""
        # 最佳选择卡片
        if 'best_choice' in parsed_eval:
            best_card = QFrame()
            best_card._is_best_card = True  # 标记为最佳选择卡片
            self.structured_cards.append(best_card)

            best_layout = QVBoxLayout(best_card)
            best_layout.setSpacing(8)

            best_title = QLabel(f"◐ 最佳选择：版本 {parsed_eval['best_choice']}")
            best_title.setStyleSheet(f"""
                font-size: {sp(16)}px;
                font-weight: 600;
                color: {theme_manager.WARNING};
            """)
            best_layout.addWidget(best_title)

            if 'reason_for_choice' in parsed_eval:
                best_reason = QLabel(parsed_eval['reason_for_choice'])
                best_reason.setWordWrap(True)
                best_reason.setStyleSheet(f"""
                    font-size: {sp(14)}px;
                    color: {theme_manager.PRIMARY};
                """)
                best_layout.addWidget(best_reason)

            layout.addWidget(best_card)

        # 各版本评估
        if 'evaluation' in parsed_eval:
            for version_name, eval_result in parsed_eval['evaluation'].items():
                version_card = QFrame()
                self.structured_cards.append(version_card)

                version_layout = QVBoxLayout(version_card)
                version_layout.setSpacing(12)

                # 版本标题
                version_title = QLabel(f"版本 {version_name.replace('version', '')} 评估")
                version_title.setStyleSheet(f"""
                    font-size: {sp(18)}px;
                    font-weight: 700;
                    color: {theme_manager.TEXT_PRIMARY};
                """)
                version_layout.addWidget(version_title)

                # 综合评价
                if 'overall_review' in eval_result:
                    overall_widget = QWidget()
                    overall_layout = QVBoxLayout(overall_widget)
                    overall_layout.setContentsMargins(0, 0, 0, 0)
                    overall_layout.setSpacing(4)

                    overall_label = QLabel("综合评价:")
                    overall_label.setStyleSheet(f"""
                        font-weight: 600;
                        color: {theme_manager.TEXT_PRIMARY};
                        font-size: {sp(14)}px;
                    """)
                    overall_layout.addWidget(overall_label)

                    overall_content = QLabel(eval_result['overall_review'])
                    overall_content.setWordWrap(True)
                    overall_content.setStyleSheet(f"""
                        color: {theme_manager.TEXT_SECONDARY};
                        font-size: {sp(14)}px;
                    """)
                    overall_layout.addWidget(overall_content)

                    version_layout.addWidget(overall_widget)

                # 优点
                if 'pros' in eval_result and eval_result['pros']:
                    pros_widget = QWidget()
                    pros_layout = QVBoxLayout(pros_widget)
                    pros_layout.setContentsMargins(0, 0, 0, 0)
                    pros_layout.setSpacing(4)

                    pros_label = QLabel("优点:")
                    pros_label.setStyleSheet(f"""
                        font-weight: 600;
                        color: {theme_manager.TEXT_PRIMARY};
                        font-size: {sp(14)}px;
                    """)
                    pros_layout.addWidget(pros_label)

                    for pro in eval_result['pros']:
                        pro_item = QLabel(f"• {pro}")
                        pro_item.setWordWrap(True)
                        pro_item.setStyleSheet(f"""
                            color: {theme_manager.TEXT_SECONDARY};
                            font-size: {sp(14)}px;
                            padding-left: 16px;
                        """)
                        pros_layout.addWidget(pro_item)

                    version_layout.addWidget(pros_widget)

                # 缺点
                if 'cons' in eval_result and eval_result['cons']:
                    cons_widget = QWidget()
                    cons_layout = QVBoxLayout(cons_widget)
                    cons_layout.setContentsMargins(0, 0, 0, 0)
                    cons_layout.setSpacing(4)

                    cons_label = QLabel("缺点:")
                    cons_label.setStyleSheet(f"""
                        font-weight: 600;
                        color: {theme_manager.TEXT_PRIMARY};
                        font-size: {sp(14)}px;
                    """)
                    cons_layout.addWidget(cons_label)

                    for con in eval_result['cons']:
                        con_item = QLabel(f"• {con}")
                        con_item.setWordWrap(True)
                        con_item.setStyleSheet(f"""
                            color: {theme_manager.TEXT_SECONDARY};
                            font-size: {sp(14)}px;
                            padding-left: 16px;
                        """)
                        cons_layout.addWidget(con_item)

                    version_layout.addWidget(cons_widget)

                layout.addWidget(version_card)


class WDVersionDetailModal(QDialog):
    """版本详情对话框 - 禅意风格

    对应Vue3组件：WDVersionDetailModal.vue

    UI规范：
    - 遮罩层：50%黑色半透明 + 背景模糊
    - 最大宽度：896px
    - 最大高度：80vh
    - 头部信息：版本号、风格、字数统计
    - 内容：whitespace-pre-wrap显示正文
    - 底部：当前版本标记 + 选择按钮
    """

    versionSelected = pyqtSignal()  # 选择版本时发射

    def __init__(self, version_index=0, version_data=None, is_current=False, parent=None):
        super().__init__(parent)
        self.version_index = version_index
        self.version_data = version_data or {}
        self.is_current = is_current

        # 存储UI组件引用
        self.overlay = None
        self.dialog_widget = None
        self.header = None
        self.title_label = None
        self.meta_label = None
        self.close_btn = None
        self.scroll_area = None
        self.content_label = None
        self.footer = None
        self.current_badge = None
        self.placeholder_label = None
        self.close_footer_btn = None
        self.select_btn = None

        self.setWindowFlags(Qt.WindowType.FramelessWindowHint | Qt.WindowType.Dialog)
        self.setAttribute(Qt.WidgetAttribute.WA_TranslucentBackground)

        # 获取屏幕尺寸
        screen = QApplication.primaryScreen().geometry()
        self.max_height = int(screen.height() * 0.8)

        self.setupUI()

        # 连接主题变化信号
        theme_manager.theme_changed.connect(self._apply_theme)

    def setupUI(self):
        """初始化UI"""
        # 主布局
        main_layout = QVBoxLayout(self)
        main_layout.setContentsMargins(0, 0, 0, 0)

        # 遮罩层
        self.overlay = QWidget(self)
        self.overlay.mousePressEvent = lambda e: self.reject() if e.button() == Qt.MouseButton.LeftButton else None

        # 对话框容器
        container_layout = QVBoxLayout(self.overlay)
        container_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)
        container_layout.setContentsMargins(16, 16, 16, 16)

        # 对话框主体
        self.dialog_widget = QWidget()
        self.dialog_widget.setFixedWidth(dp(896))
        self.dialog_widget.setMaximumHeight(self.max_height)

        dialog_layout = QVBoxLayout(self.dialog_widget)
        dialog_layout.setContentsMargins(0, 0, 0, 0)
        dialog_layout.setSpacing(0)

        # 头部
        self.header = QWidget()
        header_layout = QHBoxLayout(self.header)
        header_layout.setContentsMargins(20, 16, 20, 16)  # 减小from 24px

        # 左侧：标题和元信息
        left_widget = QWidget()
        left_layout = QVBoxLayout(left_widget)
        left_layout.setContentsMargins(0, 0, 0, 0)
        left_layout.setSpacing(4)

        self.title_label = QLabel("版本详情")
        left_layout.addWidget(self.title_label)

        # 元信息（版本号、风格、字数）
        content = self.cleanVersionContent(self.version_data.get('content', ''))
        word_count = len(content)
        style = self.version_data.get('style', '标准')

        meta_text = f"版本 {self.version_index + 1}  •  {style}风格  •  约 {round(word_count / 100) * 100} 字"
        self.meta_label = QLabel(meta_text)
        left_layout.addWidget(self.meta_label)

        header_layout.addWidget(left_widget)
        header_layout.addStretch()

        # 关闭按钮
        self.close_btn = QPushButton("✕")
        self.close_btn.setFixedSize(dp(36), dp(36))
        self.close_btn.setCursor(Qt.CursorShape.PointingHandCursor)
        self.close_btn.clicked.connect(self.reject)
        header_layout.addWidget(self.close_btn)

        dialog_layout.addWidget(self.header)

        # 内容区域
        self.scroll_area = QScrollArea()
        self.scroll_area.setWidgetResizable(True)
        self.scroll_area.setFrameShape(QFrame.Shape.NoFrame)

        content_widget = QWidget()
        content_layout = QVBoxLayout(content_widget)
        content_layout.setContentsMargins(20, 16, 20, 16)  # 减小from 24px

        self.content_label = QLabel(content)
        self.content_label.setWordWrap(True)
        self.content_label.setTextFormat(Qt.TextFormat.PlainText)
        content_layout.addWidget(self.content_label)
        content_layout.addStretch()

        self.scroll_area.setWidget(content_widget)
        dialog_layout.addWidget(self.scroll_area)

        # 底部
        self.footer = QWidget()
        footer_layout = QHBoxLayout(self.footer)
        footer_layout.setContentsMargins(24, 16, 24, 16)

        # 当前版本标记
        if self.is_current:
            self.current_badge = QLabel("✓ 当前选中版本")
            footer_layout.addWidget(self.current_badge)
        else:
            self.placeholder_label = QLabel("未选中版本")
            footer_layout.addWidget(self.placeholder_label)

        footer_layout.addStretch()

        # 右侧按钮
        self.close_footer_btn = QPushButton("关闭")
        self.close_footer_btn.setFixedHeight(dp(32))  # 减小from 36px
        self.close_footer_btn.setCursor(Qt.CursorShape.PointingHandCursor)
        self.close_footer_btn.clicked.connect(self.reject)
        footer_layout.addWidget(self.close_footer_btn)

        # 选择按钮（仅未选中时显示）
        if not self.is_current:
            self.select_btn = QPushButton("选择此版本")
            self.select_btn.setFixedHeight(dp(32))  # 减小from 36px
            self.select_btn.setCursor(Qt.CursorShape.PointingHandCursor)
            self.select_btn.clicked.connect(self.onSelectVersion)
            footer_layout.addWidget(self.select_btn)

        dialog_layout.addWidget(self.footer)

        container_layout.addWidget(self.dialog_widget)
        main_layout.addWidget(self.overlay)

        # 应用主题
        self._apply_theme()

    def _apply_theme(self):
        """应用主题样式"""
        # 获取当前是否为深色模式
        is_dark = theme_manager.is_dark_mode()

        if self.overlay:
            # 使用主题遮罩层颜色
            overlay_color = theme_manager.OVERLAY_COLOR
            self.overlay.setStyleSheet(f"background-color: {overlay_color};")

        if self.dialog_widget:
            self.dialog_widget.setStyleSheet(f"""
                QWidget {{
                    background-color: {theme_manager.BG_CARD};
                    border-radius: {theme_manager.RADIUS_LG};
                }}
            """)

        if self.header:
            self.header.setStyleSheet(f"""
                QWidget {{
                    background-color: {theme_manager.BG_TERTIARY};
                    border-bottom: 1px solid {theme_manager.BORDER_LIGHT};
                    border-top-left-radius: {theme_manager.RADIUS_LG};
                    border-top-right-radius: {theme_manager.RADIUS_LG};
                }}
            """)

        if self.title_label:
            self.title_label.setStyleSheet(f"""
                font-size: {sp(20)}px;
                font-weight: 700;
                color: {theme_manager.TEXT_PRIMARY};
            """)

        if self.meta_label:
            self.meta_label.setStyleSheet(f"""
                font-size: {sp(14)}px;
                color: {theme_manager.TEXT_SECONDARY};
            """)

        if self.close_btn:
            self.close_btn.setStyleSheet(f"""
                QPushButton {{
                    background-color: transparent;
                    color: {theme_manager.TEXT_SECONDARY};
                    border: none;
                    border-radius: {theme_manager.RADIUS_SM};
                    font-size: {sp(20)}px;
                }}
                QPushButton:hover {{
                    background-color: {theme_manager.SUCCESS_BG};
                    color: {theme_manager.TEXT_PRIMARY};
                }}
            """)

        if self.scroll_area:
            self.scroll_area.setStyleSheet(f"""
                QScrollArea {{
                    background-color: {theme_manager.BG_TERTIARY};
                    border: none;
                }}
                {theme_manager.scrollbar()}
            """)

        if self.content_label:
            self.content_label.setStyleSheet(f"""
                font-size: 15px;
                color: {theme_manager.TEXT_SECONDARY};
                line-height: 1.7;
            """)

        if self.footer:
            self.footer.setStyleSheet(f"""
                QWidget {{
                    background-color: {theme_manager.BG_SECONDARY};
                    border-top: 1px solid {theme_manager.BORDER_LIGHT};
                    border-bottom-left-radius: {theme_manager.RADIUS_LG};
                    border-bottom-right-radius: {theme_manager.RADIUS_LG};
                }}
            """)

        if self.current_badge:
            self.current_badge.setStyleSheet(f"""
                background-color: {theme_manager.SUCCESS_BG};
                color: {theme_manager.SUCCESS};
                padding: 4px 12px;
                border-radius: {theme_manager.RADIUS_SM};
                font-size: {theme_manager.FONT_SIZE_SM};
                font-weight: {theme_manager.FONT_WEIGHT_SEMIBOLD};
            """)

        if self.placeholder_label:
            self.placeholder_label.setStyleSheet(f"""
                color: {theme_manager.TEXT_SECONDARY};
                font-size: {sp(14)}px;
            """)

        if self.close_footer_btn:
            self.close_footer_btn.setStyleSheet(theme_manager.button_ghost())

        if self.select_btn:
            self.select_btn.setStyleSheet(f"""
                QPushButton {{
                    background-color: {theme_manager.PRIMARY};
                    color: {theme_manager.BUTTON_TEXT};
                    border: none;
                    border-radius: {theme_manager.RADIUS_SM};
                    padding: 0 24px;
                    font-size: {theme_manager.FONT_SIZE_SM};
                    font-weight: {theme_manager.FONT_WEIGHT_SEMIBOLD};
                }}
                QPushButton:hover {{
                    background-color: {theme_manager.WARNING};
                }}
            """)

    def cleanVersionContent(self, content):
        """清理版本内容"""
        if not content:
            return ''

        try:
            parsed = json.loads(content)
            if isinstance(parsed, dict) and 'content' in parsed:
                content = parsed['content']
        except (json.JSONDecodeError, ValueError, TypeError):
            pass

        # 清理转义字符
        cleaned = content.strip('"')
        cleaned = cleaned.replace('\\n', '\n')
        cleaned = cleaned.replace('\\"', '"')
        cleaned = cleaned.replace('\\t', '\t')
        cleaned = cleaned.replace('\\\\', '\\')

        return cleaned

    def onSelectVersion(self):
        """选择版本"""
        self.versionSelected.emit()
        self.accept()


class WDGenerateOutlineModal(QDialog):
    """生成大纲对话框 - 禅意风格

    对应Vue3组件：WDGenerateOutlineModal.vue

    UI规范：
    - 遮罩层：灰色75%透明
    - 最大宽度：512px
    - 特色：灰绿色圆形图标 + 数字输入 + 快捷按钮(1/2/5/10章)
    - 按钮：生成(主要) + 取消(次要)
    """

    generated = pyqtSignal(int)  # 生成时发射章节数

    def __init__(self, parent=None):
        super().__init__(parent)

        # 存储UI组件引用
        self.overlay = None
        self.dialog_widget = None
        self.content_widget = None
        self.icon_label = None
        self.title_label = None
        self.desc_label = None
        self.num_input = None
        self.quick_buttons = []
        self.footer = None
        self.cancel_btn = None
        self.generate_btn = None

        self.setWindowFlags(Qt.WindowType.FramelessWindowHint | Qt.WindowType.Dialog)
        self.setAttribute(Qt.WidgetAttribute.WA_TranslucentBackground)
        self.setupUI()

        # 连接主题变化信号
        theme_manager.theme_changed.connect(self._apply_theme)

    def setupUI(self):
        """初始化UI"""
        # 主布局
        main_layout = QVBoxLayout(self)
        main_layout.setContentsMargins(0, 0, 0, 0)

        # 遮罩层
        self.overlay = QWidget(self)
        self.overlay.mousePressEvent = lambda e: self.reject() if e.button() == Qt.MouseButton.LeftButton else None

        # 对话框容器
        container_layout = QVBoxLayout(self.overlay)
        container_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)
        container_layout.setContentsMargins(16, 16, 16, 16)

        # 对话框主体
        self.dialog_widget = QWidget()
        self.dialog_widget.setFixedWidth(512)  # max-w-lg = 32rem

        dialog_layout = QVBoxLayout(self.dialog_widget)
        dialog_layout.setContentsMargins(0, 0, 0, 0)
        dialog_layout.setSpacing(0)

        # 主内容区
        self.content_widget = QWidget()
        content_layout = QVBoxLayout(self.content_widget)
        content_layout.setContentsMargins(20, 24, 20, 20)

        # 顶部：图标 + 标题
        header_layout = QHBoxLayout()
        header_layout.setSpacing(16)

        # 灰绿色圆形图标
        self.icon_label = QLabel()
        self.icon_label.setFixedSize(dp(48), dp(48))
        self.icon_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.icon_label.setText("◐")
        header_layout.addWidget(self.icon_label)

        # 标题和描述
        title_widget = QWidget()
        title_layout = QVBoxLayout(title_widget)
        title_layout.setContentsMargins(0, 0, 0, 0)
        title_layout.setSpacing(4)

        self.title_label = QLabel("生成后续大纲")
        title_layout.addWidget(self.title_label)

        self.desc_label = QLabel("请输入或选择要生成的后续章节数量。")
        self.desc_label.setWordWrap(True)
        title_layout.addWidget(self.desc_label)

        header_layout.addWidget(title_widget, stretch=1)
        content_layout.addLayout(header_layout)

        # 表单区域
        form_layout = QVBoxLayout()
        form_layout.setContentsMargins(0, 24, 0, 0)
        form_layout.setSpacing(12)

        form_label = QLabel("生成数量")
        form_layout.addWidget(form_label)

        # 数字输入框
        self.num_input = QSpinBox()
        self.num_input.setRange(1, 20)
        self.num_input.setValue(5)
        form_layout.addWidget(self.num_input)

        # 快捷按钮（1/2/5/10章）
        quick_btns_layout = QHBoxLayout()
        quick_btns_layout.setSpacing(12)
        quick_btns_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)

        for count in [1, 2, 5, 10]:
            btn = QPushButton(f"{count} 章")
            btn.setCursor(Qt.CursorShape.PointingHandCursor)
            btn.clicked.connect(lambda checked, c=count: self.num_input.setValue(c))
            self.quick_buttons.append(btn)
            quick_btns_layout.addWidget(btn)

        form_layout.addLayout(quick_btns_layout)
        content_layout.addLayout(form_layout)

        dialog_layout.addWidget(self.content_widget)

        # 底部按钮区
        self.footer = QWidget()
        footer_layout = QHBoxLayout(self.footer)
        footer_layout.setContentsMargins(20, 12, 20, 12)  # 统一边距
        footer_layout.setSpacing(12)
        footer_layout.addStretch()

        # 取消按钮
        self.cancel_btn = QPushButton("取消")
        self.cancel_btn.setFixedHeight(dp(32))  # 减小from 44px
        self.cancel_btn.setCursor(Qt.CursorShape.PointingHandCursor)
        self.cancel_btn.clicked.connect(self.reject)
        footer_layout.addWidget(self.cancel_btn)

        # 生成按钮
        self.generate_btn = QPushButton("生成")
        self.generate_btn.setFixedHeight(dp(32))  # 减小from 44px
        self.generate_btn.setCursor(Qt.CursorShape.PointingHandCursor)
        self.generate_btn.clicked.connect(self.onGenerate)
        footer_layout.addWidget(self.generate_btn)

        dialog_layout.addWidget(self.footer)

        container_layout.addWidget(self.dialog_widget)
        main_layout.addWidget(self.overlay)

        # 应用主题
        self._apply_theme()

    def _apply_theme(self):
        """应用主题样式"""
        # 获取当前是否为深色模式
        is_dark = theme_manager.is_dark_mode()

        if self.overlay:
            # 使用主题遮罩层颜色
            overlay_color = theme_manager.OVERLAY_COLOR
            self.overlay.setStyleSheet(f"background-color: {overlay_color};")

        if self.dialog_widget:
            self.dialog_widget.setStyleSheet(f"""
                QWidget {{
                    background-color: {theme_manager.BG_TERTIARY};
                    border-radius: {theme_manager.RADIUS_SM};
                }}
            """)

        if self.content_widget:
            self.content_widget.setStyleSheet(f"background-color: {theme_manager.BG_CARD};")

        if self.icon_label:
            self.icon_label.setStyleSheet(f"""
                background-color: {theme_manager.SUCCESS_BG};
                color: {theme_manager.PRIMARY};
                border-radius: 24px;
                font-size: {sp(28)}px;
                font-weight: 700;
            """)

        if self.title_label:
            self.title_label.setStyleSheet(f"""
                font-size: {sp(20)}px;
                font-weight: 600;
                color: {theme_manager.TEXT_PRIMARY};
            """)

        if self.desc_label:
            self.desc_label.setStyleSheet(f"""
                font-size: {sp(16)}px;
                color: {theme_manager.TEXT_SECONDARY};
            """)

        if self.num_input:
            self.num_input.setStyleSheet(f"""
                QSpinBox {{
                    padding: 12px 16px;
                    border: 1px solid {theme_manager.BORDER_DEFAULT};
                    border-radius: {theme_manager.RADIUS_MD};
                    background-color: {theme_manager.BG_SECONDARY};
                    font-size: 18px;
                    color: {theme_manager.TEXT_PRIMARY};
                }}
                QSpinBox:focus {{
                    border: 1px solid {theme_manager.PRIMARY};
                    background-color: {theme_manager.BG_TERTIARY};
                    color: {theme_manager.TEXT_PRIMARY};
                    outline: none;
                }}
            """)

        for btn in self.quick_buttons:
            btn.setStyleSheet(f"""
                QPushButton {{
                    background-color: {theme_manager.BG_TERTIARY};
                    color: {theme_manager.TEXT_SECONDARY};
                    border: none;
                    border-radius: {theme_manager.RADIUS_LG};
                    padding: 8px 20px;
                    font-size: {sp(16)}px;
                    font-weight: 500;
                }}
                QPushButton:hover {{
                    background-color: {theme_manager.SUCCESS_BG};
                    color: {theme_manager.PRIMARY};
                }}
            """)

        if self.footer:
            self.footer.setStyleSheet(f"""
                QWidget {{
                    background-color: {theme_manager.BG_SECONDARY};
                    border-bottom-left-radius: {theme_manager.RADIUS_SM};
                    border-bottom-right-radius: {theme_manager.RADIUS_SM};
                }}
            """)

        if self.cancel_btn:
            self.cancel_btn.setStyleSheet(f"""
                QPushButton {{
                    background-color: {theme_manager.BG_TERTIARY};
                    color: {theme_manager.TEXT_SECONDARY};
                    border: 1px solid {theme_manager.BORDER_DEFAULT};
                    border-radius: {theme_manager.RADIUS_SM};
                    padding: 0 20px;
                    font-size: {sp(16)}px;
                    font-weight: 500;
                }}
                QPushButton:hover {{
                    background-color: {theme_manager.BG_SECONDARY};
                }}
            """)

        if self.generate_btn:
            self.generate_btn.setStyleSheet(f"""
                QPushButton {{
                    background-color: {theme_manager.PRIMARY};
                    color: {theme_manager.BUTTON_TEXT};
                    border: none;
                    border-radius: {theme_manager.RADIUS_SM};
                    padding: 0 20px;
                    font-size: {theme_manager.FONT_SIZE_MD};
                    font-weight: {theme_manager.FONT_WEIGHT_SEMIBOLD};
                }}
                QPushButton:hover {{
                    background-color: {theme_manager.WARNING};
                }}
            """)

    def onGenerate(self):
        """生成大纲"""
        count = self.num_input.value()
        if count > 0:
            self.generated.emit(count)
            self.accept()
